# Cursor Rules for USDX Protocol

## Code Quality & Review Standards

### Code Review Requirements
- Always do a thorough multi-pass review before committing
- Remove all unused code, imports, and exports
- Ensure all added code is actually being used
- Minimize code additions - prefer refactoring existing code over adding new code
- Optimize for human readability - code should be clean, understandable, and maintainable

### CSS & Styling Guidelines
- **Maximally reuse Tailwind CSS utilities** instead of adding custom CSS
- Only add custom CSS when absolutely necessary
- Prefer Tailwind's built-in utilities and classes
- Custom CSS should be minimal and well-documented
- Avoid creating custom classes that duplicate Tailwind functionality
- **CRITICAL: Verify Tailwind class names exist** - Valid border widths are: border, border-2, border-4, border-8 (NOT border-3)
- **Design with restraint** - Use 1-2 primary colors, not 6+ different border colors
- **Modern borders** - Prefer 1-2px borders or subtle shadows over thick (4px+) borders
- **Consistent spacing** - Define and use a spacing scale, avoid magic numbers
- **Visual hierarchy** - One focal point per section, not everything competing for attention

### File Organization
- **All generated documentation files must be placed in the `docs/` folder**
- Do not create documentation files in the root directory or other locations
- Generated markdown files, research notes, and documentation should go in `usdx/docs/`
- Keep the repository structure clean and organized

### Code Simplification
- Remove unnecessary abstractions
- Prefer explicit code over clever abstractions
- Keep functions small and focused
- Remove unused exports and imports
- Don't add features "just in case" - only add what's needed

### Git Workflow
- Review all changes before committing
- Ensure commits are focused and meaningful
- Rebase on main/master before creating PRs
- Keep commit messages clear and descriptive

### Testing Requirements - CRITICAL
- **NEVER upload untested code** - All code must be tested locally before committing
- **Always run tests locally** - Never assume tests will pass without running them
- For Solidity contracts: **Always run `forge test`** before committing any contract changes
- For TypeScript/React: **Always run `npm run build` and `npm run type-check`** before committing
- If tests fail, fix them immediately - do not commit failing tests
- Install missing testing tools automatically (Foundry, npm packages, etc.) - do not complain about missing tools

### Foundry Installation & Usage
- **Install Foundry automatically** if not available:
  ```bash
  curl -L https://foundry.paradigm.xyz | bash
  source ~/.bashrc && foundryup
  ```
- Foundry binaries are installed to `~/.foundry/bin/` - add to PATH: `export PATH="$HOME/.foundry/bin:$PATH"`
- Always run `forge test` after making contract changes
- Run specific test suites: `forge test --match-contract ContractName`
- Use `-vv` flag for verbose output when debugging: `forge test -vv`

### TypeScript & Build Requirements
- **Always test builds locally** before pushing changes
- Fix all TypeScript type errors - never ignore type errors
- Ensure return types match function signatures
- Use explicit return types when type inference is unclear
- Test `npm run build` or `npm run type-check` before committing

### Design Review Standards
- **When user requests visual changes, clarify the goal first**
- Ask: "Do you want more professional polish or more visual impact?"
- **Don't overcorrect** - Subtle changes are often better than dramatic ones
- **Establish a design system** - Pick 1-2 primary colors and stick to them
- **Review with fresh eyes** - Step back and ask "Would I show this to a client?"
- **Test Tailwind classes** - Verify class names exist before using them
- **Professional borders** - Modern design uses subtle borders (1-2px) or shadows, not thick borders everywhere

### Deployment & Build Configuration - CRITICAL
- **NEVER modify deployment configs (amplify.yml, vercel.json) without testing the EXACT build flow**
- **For monorepo + Amplify/Vercel deployments:**
  - Understand where node_modules is installed (workspace root vs individual packages)
  - Ensure runtime dependencies (like 'next') are accessible in the deployment directory
  - Test the complete build flow: install → build → verify artifacts
  - For workspaces, dependencies may be hoisted to parent - handle accordingly

- **Amplify Monorepo Setup - OPTIMIZED SOLUTION:**
  - **Generate app-specific package-lock.json** to avoid installing ALL workspace dependencies
  - Set `appRoot` to the workspace root (e.g., `usdx`)
  - In preBuild: Run `cd frontend && npm ci` (installs to parent), then copy to app directory
  - Use `cp -r node_modules frontend/node_modules` (NOT cp -rL, NOT symlinks)
  - Set `baseDirectory` in artifacts to the app subdirectory (e.g., `frontend`)
  - Include: `.next/**/*`, `node_modules/**/*`, `package.json`, `package-lock.json`, `next.config.js`, `public/**/*`
  - **WHY THIS WORKS:**
    - Frontend-specific package-lock.json ensures ONLY frontend dependencies are installed (709MB vs 1.9GB)
    - Workspace hoisting installs to parent node_modules, but we copy to make artifacts self-contained
    - `cp -r` preserves internal symlinks while making directory portable
    - No duplicate React instances because we copy the entire structure as-is
  - **Generate frontend-specific package-lock.json:**
    ```bash
    cd /workspace && npm install --prefix usdx/frontend --package-lock-only
    git add usdx/frontend/package-lock.json
    ```

- **Testing Deployment Configs (MANDATORY BEFORE COMMITTING):**
  ```bash
  # Test EXACT Amplify build flow:
  cd /workspace/usdx
  rm -rf frontend/.next frontend/node_modules node_modules
  cd frontend && npm ci                     # Install frontend-only deps (699MB)
  cd .. && cp -r node_modules frontend/node_modules  # Copy to frontend (709MB)
  cd frontend && npm run build              # Build
  ls -la node_modules/next                  # Verify 'next' exists
  node -e "console.log(require.resolve('next'))"  # Verify resolution
  du -sh .next node_modules                 # Verify sizes (84MB + 709MB)
  ```

- **Deployment Config Review Checklist:**
  1. Does frontend have its own package-lock.json? (CRITICAL for size optimization)
  2. Is appRoot set to workspace root (where workspace hoisting occurs)?
  3. Is `cd frontend && npm ci` used (not just `npm ci` from root)?
  4. Is `cp -r node_modules frontend/node_modules` in preBuild phase?
  5. Does baseDirectory point to the app directory?
  6. Does artifacts include both `package.json` AND `package-lock.json`?
  7. Have I tested the EXACT commands and verified node_modules is ~700MB, not 1.9GB?
  8. Does `require.resolve('next')` work from the app directory?

- **Common Mistakes to AVOID:**
  - ❌ Installing all workspace deps - Creates 1.9GB node_modules (contracts + backend + frontend)
  - ❌ Missing frontend/package-lock.json - Will install all workspace dependencies
  - ❌ Using symlinks (`ln -s`) - Amplify may not follow them in artifacts
  - ❌ Using `cp -rL` (follow symlinks) - Breaks on circular refs in node_modules
  - ❌ Using `../node_modules/**/*` in artifacts - Path resolution issues
  - ❌ Not verifying node_modules size after install

### Self-Assessment Checklist
Before committing, ask:
1. **Have I run all tests locally and verified they pass?** (CRITICAL - never skip this)
2. Is all the code I added actually being used?
3. Can I simplify this further?
4. Am I using Tailwind utilities instead of custom CSS?
5. **Have I verified all Tailwind classes are valid?** (border-3 doesn't exist!)
6. Are there any unused imports or exports?
7. Have I moved all generated docs to the docs folder?
8. Is the code readable and maintainable?
9. **Does `npm run build` pass without errors?** (for frontend changes)
10. **Does `forge test` pass without errors?** (for contract changes)
11. **Are all TypeScript types correct?**
12. **Would a professional designer approve this?** (for UI changes)
13. **Is there a consistent color palette (max 2-3 colors)?** (for UI changes)
14. **Did I establish clear visual hierarchy?** (for UI changes)
15. **Have I tested the EXACT deployment build flow locally?** (for amplify.yml/vercel.json changes)
